{% extends 'base_public.html.twig' %}

{% block body %}
    <h3>{{ training.title }}</h3>
    <p>{{ training.trainingType }}</p>
    <p>{{ training.description }}</p>
    <p>{{ training.place }}</p>
    {% if training.start.diff(training.end).days == 0 %}
        <p>{{ training.start|date('d.m.Y, H:i') }} - {{ training.end|date('H:i') }}</p>
    {% else %}
        <p>{{ training.start|date('d.m.Y H:i') }} - {{ training.end|date('d.m.Y H:i') }}</p>
    {% endif %}
    <p>Mit E-Mail anmelden:
        <input id="email" />
    </p>
    <p id="emailResults">
    </p>
    <p id="registerNew">
    </p>
{% endblock %}

{% block javascripts %}
<script>
function validateEmail(sEmail) {
    var filter = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
    if (filter.test(sEmail)) {
        return true;
    }
    else {
        return false;
    }
}

function registerEmail() {
    $("input").prop('disabled', true);
    $("button").remove();
    $.post("{{ path('register_person') }}", {
        firstName: $('[name="firstName"]').val(),
        familyName: $('[name="familyName"]').val(),
        email: $('#email').val()
    }, function (result) {
        if (result.success) {
            $.get("{{ path('subscribe_person_for_training', {'person': '__person__', 'hash': hash}) }}".replace("__person__", result.person.id), null, function () {
                $("#registerNew").append($("<p>", {
                    text: "Anmeldung erfolgreich erfasst."
                }));
            });
        } else {
            $("#registerNew").append($("<p>", {
                text: "Fehler bei der Anmeldung. Bitte Seite neu laden."
            }));
        }
    });
}

function subscribePerson(personId) {
    $("input").prop('disabled', true);
    $("button").remove();
    $("a").attr("onclick", "");
    $.post("{{ path('subscribe_person_for_training', {'person': '__person__', 'hash': hash}) }}".replace("__person__", personId), null, function (res) {
        $("#registerNew").append($("<p>", {
            text: res.person.firstName + " " + res.person.familyName + " erfolgreich angemeldet"
        }));
    });
}

function unsubscribePerson(personId) {
    $("input").prop('disabled', true);
    $("button").remove();
    $("a").attr("onclick", "");
    $.post("{{ path('unsubscribe_person_for_training', {'person': '__person__', 'hash': hash}) }}".replace("__person__", personId), null, function (res) {
        $("#registerNew").append($("<p>", {
            text: res.person.firstName + " " + res.person.familyName + " erfolgreich abgemeldet"
        }));
    });
}

$(function() {
    $("#email").on("keyup", function (evt) {
        var mailField = $("#email");
        var registerNewField = $("#registerNew");
        registerNewField.html("");
        if (validateEmail(mailField.val())) {
            registerNewField.append($('<p>', {
                text: 'Vorname: '
                }).append($('<input>', {
                    name: 'firstName',
                    type: 'text'
            }))).append($('<p>', {
                text: 'Nachname: '
                }).append($('<input>', {
                    name: 'familyName',
                    type: 'text'
            }))).append($('<button>', {
                onclick: "registerEmail();",
                text: "Neu registrieren"
            }));
            var url = "{{ path('find_person_by_mail', {'mail': '__mail__', 'hash': hash}) }}".replace("__mail__", mailField.val());
            $.get(url, null, function (result) {
                var registeredPersons = result.registered;
                var unregisteredPersons = result.unregistered;
                var resField = $("#emailResults");
                resField.html("");
                if (registeredPersons.length > 0 || unregisteredPersons.length > 0) {
                    var ulContainer = resField.append($('<ul>')).children().filter('ul');
                    unregisteredPersons.forEach(item => {
                        ulContainer.append($('<li>').append($('<a>', {
                            href: "javascript:void(0);",
                            onclick: "javascript:subscribePerson(" + item.id + ")",
                            text: item.firstName + ' ' + item.familyName + ' für Training anmelden'
                        })));
                    });
                    registeredPersons.forEach(item => {
                        ulContainer.append($('<li>').append($('<a>', {
                            href: "javascript:void(0);",
                            onclick: "javascript:unsubscribePerson(" + item.id + ")",
                            text: item.firstName + ' ' + item.familyName + ' für Training abmelden'
                        })));
                    });
                }
            })
        }
    });
});
</script>
{% endblock %}
