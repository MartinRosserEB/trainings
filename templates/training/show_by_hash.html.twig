{% extends 'base.html.twig' %}

{% block body %}
    <h3>{{ training.title }}</h3>
    <p>{{ training.trainingType }}</p>
    <p>{{ training.description }}</p>
    <p>{{ training.place }}</p>
    {% if training.start.diff(training.end).days == 0 %}
        <p>{{ training.start|date('d.m.Y, H:i') }} - {{ training.end|date('H:i') }}</p>
    {% else %}
        <p>{{ training.start|date('d.m.Y H:i') }} - {{ training.end|date('d.m.Y H:i') }}</p>
    {% endif %}
    <p>Mit E-Mail anmelden:
        <input id="email" />
    </p>
    <p id="emailResults">
    </p>
    <p id="registerNew">
    </p>
{% endblock %}

{% block javascripts %}
<script>
function validateEmail(sEmail) {
    var filter = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
    if (filter.test(sEmail)) {
        return true;
    }
    else {
        return false;
    }
}

function registerEmail() {
    $("input").prop('disabled', true);
    $("button").remove();
    $.post("{{ path('register_user') }}", {
        firstName: $('[name="firstName"]').val(),
        familyName: $('[name="familyName"]').val(),
        email: $('#email').val()
    }, function (result) {
        if (result.success) {
            var user = JSON.parse(result.user);
            $.get("{{ path('enlist_user_for_training', {'user': '__user__', 'hash': hash}) }}".replace("__user__", user.id), null, function () {
                $("#registerNew").append($("<p>", {
                    text: "Anmeldung erfolgreich erfasst."
                }));
            });
        } else {
            $("#registerNew").append($("<p>", {
                text: "Fehler bei der Anmeldung. Bitte Seite neu laden."
            }));
        }
    });
}

function enlistUser(userId) {
    $("input").prop('disabled', true);
    $("button").remove();
    $("a").attr("onclick", "");
    $.post("{{ path('enlist_user_for_training', {'user': '__user__', 'hash': hash}) }}".replace("__user__", userId), null, function () {
        $("#registerNew").append($("<p>", {
            text: "Benutzer erfolgreich angemeldet"
        }));
    });
}

$(function() {
    $("#email").on("keyup", function (evt) {
        var mailField = $("#email");
        var registerNewField = $("#registerNew");
        registerNewField.html("");
        if (validateEmail(mailField.val())) {
            registerNewField.append($('<p>', {
                text: 'Vorname: '
                }).append($('<input>', {
                    name: 'firstName',
                    type: 'text'
            }))).append($('<p>', {
                text: 'Nachname: '
                }).append($('<input>', {
                    name: 'familyName',
                    type: 'text'
            }))).append($('<button>', {
                onclick: "registerEmail();",
                text: "Neu registrieren"
            }));
            var url = "{{ path('find_user_by_mail', {'mail': '__mail__'}) }}".replace("__mail__", mailField.val());
            $.get(url, null, function (result) {
                var resArray = JSON.parse(result);
                var resField = $("#emailResults");
                resField.html("");
                if (resArray.length > 0) {
                    resArray.forEach(item => {
                        resField.append($('<a>', {
                            href: "javascript:void(0);",
                            onclick: "javascript:enlistUser(" + item.id + ")",
                            text: item.firstName + ' ' + item.familyName + ' f√ºr Training anmelden'
                        }));
                    })
                }
            })
        }
    });
});
</script>
{% endblock %}
